<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Student Dashboard</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }

    .progress-bar {
      background: #ccc;
      height: 10px;
      border-radius: 10px;
      margin-top: 10px;
    }

    .progress {
      background: blueviolet;
      height: 10px;
      width: {{ progress }}%;
      border-radius: 10px;
    }

    .task {
      margin: 10px 0;
      padding: 10px;
      background: #f4f4f4;
      border-radius: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .tick-btn {
      padding: 5px 10px;
      background: green;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .tick-btn.unmark {
      background: gray;
    }

    .review-btn {
      margin-top: 20px;
      padding: 10px 20px;
      background-color: dodgerblue;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
    }

    .logout {
      text-align: right;
      margin-bottom: 20px;
    }

    .logout a {
      color: crimson;
      text-decoration: none;
      font-weight: bold;
    }

    .help-buttons button {
      margin: 5px 5px 0 0;
      padding: 8px 14px;
      background-color: #444;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<div style="display: flex; flex-wrap: wrap; gap: 24px; align-items: flex-start; justify-content: space-between; margin-bottom: 30px;">

  <!-- Student Profile Sidebar -->
  <div class="w-full md:w-1/4 bg-white rounded-lg shadow p-6">
  <div class="flex flex-col items-center">

    <!-- ‚úÖ PROFILE PICTURE BLOCK -->
    {% if student.s_profilepicture %}
      <img src="{{ student.s_profilepicture.url }}" 
           alt="Profile Picture" 
           style="width: 100px; height: 100px; object-fit: cover; border-radius: 50%; margin-bottom: 10px;">
    {% else %}
      <div style="width: 100px; height: 100px; background: #ccc; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 10px;">
        <span style="color: #555;">No Photo</span>
      </div>
    {% endif %}
    <!-- ‚úÖ END PROFILE PICTURE BLOCK -->

    <h3 class="text-lg font-medium">{{ student.s_firstname }} {{ student.s_lastname }}</h3>
    <p class="text-gray-500 text-sm">Student</p>
    <div class="mt-4 flex space-x-2">
      <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">{{ student.s_status }}</span>
      <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full">Qualification: {{ student.s_qualification }}</span>
    </div>
  </div>
</div>


  <!-- Module Section -->
  <div style="flex: 1; min-width: 300px; max-width: 800px;">
    <h2>Welcome {{ student.s_firstname }} ({{ student.s_email }})</h2>
    <h2>Current Module: {{ module.name }}</h2>
    <p>Week {{ module.week }}</p>

    <div class="progress-bar">
      <div class="progress" style="width: {{ progress }}%;"></div>
    </div>
    <p>{{ completed }} / {{ total }} tasks completed</p>

    {% for item in task_statuses %}
      <div class="task">
        <span>{{ item.task.title }}</span>
        <button 
          class="tick-btn {% if item.is_completed %}unmark{% endif %}" 
          data-task-id="{{ item.task.id }}" 
          style="{% if item.is_completed %}background-color: gray;{% else %}background-color: green;{% endif %}">
          {% if item.is_completed %}Unmark{% else %}Mark Complete{% endif %}
        </button>
      </div>
    {% endfor %}

    <!-- Help & Review Buttons -->
    <div style="margin-top: 20px; display: flex; gap: 12px; flex-wrap: wrap;">
      <button onclick="sendHelpRequest('urgent_review')" style="background-color: red; color: white;">Schedule Urgent Review</button>

      {% if completed == total %}
        <button type="button" onclick="loadReviewPage()" class="review-btn">Submit Review</button>
      {% else %}
        <button type="button" onclick="loadReviewPage()" class="review-btn" style="display: none;">Submit Review</button>
      {% endif %}
    </div>
  </div>
  <div id="review-container" style="display:none;">
  <!-- Review content will be loaded here -->
  </div>

<div id="review-section" style="display:none; margin-top:30px; width: 100%;"></div>


  <!-- Earned Badges -->
<div style="flex: 1 1 300px; max-width: 350px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 10px; padding: 20px;">
  <h3>üèÖ Earned Badges</h3>
  {% if student_badges %}
    <ul style="list-style: none; padding: 0;">
      {% for student_badge in student_badges %}
        <li style="display: flex; align-items: center; margin-bottom: 12px;">
          {% if student_badge.badge.image %}
            <img src="{{ student_badge.badge.image.url }}" alt="{{ student_badge.badge.name }}" 
                 style="width: 40px; height: 40px; object-fit: contain; margin-right: 10px; border-radius: 6px;">
          {% endif %}
          <div>
            <strong>{{ student_badge.badge.name }}</strong><br>
            <small>Awarded for {{ student_badge.badge.module.name }}</small>
          </div>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p>No badges earned yet.</p>
  {% endif %}
</div>

  <!-- Study Materials -->
  <div style="flex: 2 1 600px; background: white; border-radius: 10px; padding: 24px;">
    <h2>üìò Study Materials</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
      <!-- Module Materials -->
      <div>
        <h3>{{ module.name }}</h3>
        <ul>
          <li><a href="#">üìÑ Variables and Scope Guide</a></li>
          <li><a href="#">üé• Functions Tutorial Video</a></li>
          <li><a href="#">üîó Arrays Cheat Sheet</a></li>
        </ul>
      </div>

      <!-- Additional Resources -->
      <div>
        <h3>Additional Resources</h3>
        <ul>
          <li><a href="#">üåê JavaScript Documentation</a></li>
          <li><a href="#">üíª Interactive Code Exercises</a></li>
          <li><a href="#">‚ùì FAQ for Current Module</a></li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript -->
<script>
  // -------------------- CSRF Token --------------------
 // -------------------- CSRF Token --------------------
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (const cookie of cookies) {
      const c = cookie.trim();
      if (c.startsWith(name + '=')) {
        cookieValue = decodeURIComponent(c.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
const csrftoken = getCookie('csrftoken');

// -------------------- Task Completion --------------------
const completeTaskBaseURL = "{% url 'complete_task' 0 %}".replace(/0\/$/, '');

document.querySelectorAll('.tick-btn').forEach(button => {
  button.addEventListener('click', () => {
    const taskId = button.dataset.taskId;
    const url = `${completeTaskBaseURL}${taskId}/`;

    fetch(url, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrftoken,
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({})
    })
    .then(response => {
      if (response.redirected) {
        window.location.href = response.url;
        return;
      }
      if (!response.ok) {
        throw new Error(`HTTP error ${response.status}`);
      }
      return response.json();
    })
    .then(data => {
      if (!data) return;

      if (data.success) {
        button.textContent = data.is_completed ? 'Unmark' : 'Mark Complete';
        button.style.backgroundColor = data.is_completed ? 'gray' : 'green';
        button.classList.toggle('unmark', data.is_completed);

        document.querySelector('.progress').style.width = data.progress + '%';

        const completedText = document.querySelector('.progress-bar + p');
        if (completedText) {
          completedText.textContent = `${data.completed} / ${data.total} tasks completed`;
        }

        const submitBtn = document.querySelector('.review-btn');
        if (submitBtn) {
          submitBtn.style.display = (data.completed === data.total) ? 'inline-block' : 'none';
        }
      } else {
        alert(data.error || 'Task update failed.');
      }
    })
    .catch(error => {
      console.error('Fetch error:', error);
      alert('Error: ' + error.message);
    });
  });
});

// -------------------- Load Review Section via AJAX --------------------
function loadReviewPage() {
  fetch("{% url 'review_dashboard' %}")
    .then(response => {
      if (!response.ok) throw new Error("Failed to load review section.");
      return response.text();
    })
    .then(html => {
      const reviewSection = document.getElementById("review-section");
      reviewSection.innerHTML = html;
      reviewSection.style.display = 'block';  // Show review section on same page

      window.scrollTo({
        top: reviewSection.offsetTop,
        behavior: "smooth"
      });

      // Initialize event handlers for review form/buttons
      initReviewSectionEvents();
    })
    .catch(error => {
      console.error("Error loading review:", error);
      alert("Could not load the review section.");
    });
}

// -------------------- Handle Help Request Submission --------------------
function sendHelpRequest(type) {
  // Check if helpMessage textarea exists in DOM (it only exists in review section)
  const helpMessageElement = document.getElementById('helpMessage');
  const message = helpMessageElement ? helpMessageElement.value : '';

  fetch('/review/submit-help/', {
    method: 'POST',
    credentials: 'same-origin',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'X-CSRFToken': csrftoken
    },
    body: `type=${encodeURIComponent(type)}&message=${encodeURIComponent(message)}`
  })
  .then(response => {
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    return response.json();
  })
  .then(data => {
    alert(data.message);
    if (data.status === 'success' && helpMessageElement) {
      helpMessageElement.value = '';
    }
  })
  .catch(error => {
    console.error('Fetch error:', error);
    alert('Something went wrong!');
  });
}

// -------------------- Initialize review section event listeners --------------------
function initReviewSectionEvents() {
  // Help buttons inside review section
  const buttons = document.querySelectorAll('#review-section [data-help-type]');
  buttons.forEach(button => {
    button.addEventListener('click', () => {
      const type = button.getAttribute('data-help-type');
      sendHelpRequest(type);
    });
  });

  // Review form submission inside review section
  const reviewForm = document.getElementById('reviewForm');
  if (reviewForm) {
    reviewForm.addEventListener('submit', function(event) {
      event.preventDefault();

      const formData = new FormData(reviewForm);

      fetch(reviewForm.action, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
          'Accept': 'application/json',
        },
        body: formData,
      })
      .then(response => {
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        return response.json();
      })
      .then(data => {
        if (data.status === 'success') {
          alert('Review submitted successfully!');
          document.getElementById('review-section').style.display = 'none';
          // Optionally refresh or update dashboard content here
        } else {
          alert(data.message || 'Failed to submit review.');
        }
      })
      .catch(error => {
        console.error('Error submitting review:', error);
        alert('Something went wrong while submitting review.');
      });
    });
  }
}

</script>



</body>
</html>

